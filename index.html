<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Sintetizador Web</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .contenedor {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }

    .recuadro_Principal {
      top: 20px;
      position: absolute;
      width: 1000px;
      height: 600px;
      background: black url('PISTA.png') center center no-repeat;
      background-size: cover;
      z-index: -1;
    }

    .controls {
      position: relative;
      width: 800px;
      height: 200px;
    }

    .control {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 50px;
      height: 140px;
      top: -90px;
    }

    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100px;
      height: 8px;
      background: #222;
      border-radius: 5px;
      transform: rotate(-90deg);
      transform-origin: center;
      margin: 20px 0;
      box-shadow: 0 0 6px #0f0;
    }

    input[type="range"]::-webkit-slider-runnable-track {
      height: 8px;
      background: #111;
      border: 1px solid #0f0;
      border-radius: 4px;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #0f0;
      border: 2px solid #000;
      border-radius: 50%;
      margin-top: -4px;
      box-shadow: 0 0 4px #0f0;
    }

    .control span {
      margin-top: 10px;
      font-size: 14px;
      color: #0f0;
    }

    .knob {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #222;
      border: 2px solid #429869;
      position: relative;
      cursor: grab;
      user-select: none;
    }

    .knob-marker {
      width: 4px;
      height: 35%;
      background: #429869;
      position: absolute;
      top: 15%;
      left: 50%;
      transform-origin: bottom center;
      transform: rotate(0deg);
    }
    
    .wave-btn,#transposeDown,#transposeUp {
      width: 60px;
      height: 60px;
      background-color: black;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
      border: none;
      cursor: pointer;
    }

    .wave-btn.selected {
      box-shadow: 0 0 0 5px rgba(255, 255, 0, 0.3);
      outline: 2px solid rgba(255, 255, 0, 0.5);
      border-radius: 8px;
    }

    button.transpose-highlight {
      box-shadow: 0 0 0 5px rgba(255, 255, 0, 0.3);
      outline: 2px solid rgba(255, 255, 0, 0.5);
      border-radius: 6px;
    }

    .TECLADO {
      top: 70px;
      left: 43px;
      position: absolute;
      width: 980px;
      height: 300px;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      position: relative;
    }

    .TECLAS_BLANCAS {
      top:-10px;
      background: white;
      width: 60px;
      height: 200px;
      margin: 2px;
      border-radius: 0 0 10px 10px;
      z-index: 1;
    }

    .TECLAS_NEGRAS {
      position: absolute;
      background: black;
      width: 40px;
      height: 120px;
      z-index: 2;
      border-radius: 0 0 5px 5px;
    }

    canvas {
      position: absolute;
      width: 500px;
      height: 50px;
      top: 90px;
      left: 600px;
      background: #000;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
  <div class="contenedor">
    <div class="recuadro_Principal"></div>
    <div class="controls">

      <div class="control" style="left: 0px;">
        <div id="waveButtons" style="display:flex; flex-direction: row; gap: 6px; margin-top:90px; margin-left: 220px;">
          <button class="wave-btn selected" data-wave="sine" style="background-image: url('BOTON VIBE SENO.png');"></button>
          <button class="wave-btn" data-wave="square" style="background-image: url('BOTON VIBE CUADRADO.png');"></button>
          <button class="wave-btn" data-wave="sawtooth" style="background-image: url('BOTON VIBE SIERRA.png');"></button>
          <button class="wave-btn" data-wave="triangle" style="background-image: url('BOTON VIBE TRIANGULO.png');"></button>
          <button class="wave-btn" data-wave="white" style="background-image: url('BOTON VIBE RUIDO BLANCO.png');"></button>

          <!-- NUEVO: bot√≥n Custom -->
          <button class="wave-btn" id="customWaveBtn" data-wave="custom" style="background-image: url('BOTON VIBE RUIDO BLANCO.png');"></button>
          <input type="file" id="customFile" accept=".wav,.mp3,.ogg" style="display:none" />
        </div>
      </div>

      <!-- Control tipo potenci√≥metro para Arm√≥nicos -->
      <div class="control" style="top:-50px; left: 420px;">
        <div class="knob" id="harmonicsKnob">
          <div class="knob-marker" id="harmonicsMarker"></div>
        </div>
        <span id="harmonicsVal" style="color:#429869;">0</span>
      </div>

      <div class="control" style="top: 80px; left: 0px;">
        <div style="display: flex; flex-direction: column; gap: 6px; align-items: center;">
          <div style="display: flex; flex-direction: row; gap: 6px; align-items: center;">
            <button id="transposeDown" style="background-image: url('+ OCTV.png');"></button>
            <button id="transposeUp" style="background-image: url('- OCTV.png');"></button>
          </div>
        </div>
      </div>

      <!-- Slider de volumen -->
      <div class="control" style="top:-10px; left: 230px;">
        <input type="range" id="volume" min="0" max="1" step="0.01" value="0.5" />
        <span id="volumeVal">0.50</span>
      </div>

      <!-- Slider de detune -->
      <div class="control" style="top:-10px; left: 330px;">
        <input type="range" id="detune" min="-100" max="100" step="1" value="0" />
        <span id="detuneVal">0</span>
      </div>

      <!-- Potenci√≥metros -->
      <div class="control" style="top:-50px; left: 500px;">
        <div class="knob" id="attackKnob">
          <div class="knob-marker" id="attackMarker">ATTACK</div>
        </div>
        <span id="attackVal">0.05</span>
      </div>

      <div class="control" style="top:-50px; left: 580px;">
        <div class="knob" id="decayKnob">
          <div class="knob-marker" id="decayMarker">DECAY</div>
        </div>
        <span id="decayVal">0.30</span>
      </div>

      <div class="control" style="top:-50px; left: 660px;">
        <div class="knob" id="releaseKnob">
          <div class="knob-marker" id="releaseMarker">RELEASE</div>
        </div>
        <span id="releaseVal">0.50</span>
      </div>

      <div class="control" style="top:-50px; left: 740px;">
        <div class="knob" id="sustainKnob">
          <div class="knob-marker" id="sustainMarker">SUSTAIN</div>
        </div>
        <span id="sustainVal">0.70</span>
      </div>

      <div class="control" style="top:50px; left: 540px;">
        <div class="knob" id="filterKnob">
          <div class="knob-marker" id="filterMarker"></div>
        </div>
        <span id="filterVal">5000</span>
      </div>

      <div class="control" style="top:50px; left: 620px;">
        <div class="knob" id="delayKnob">
          <div class="knob-marker" id="delayMarker"></div>
        </div>
        <span id="delayVal">0.20</span>
      </div>

      <div class="control" style="top:50px; left: 700px;">
        <div class="knob" id="distortionKnob">
          <div class="knob-marker" id="distortionMarker"></div>
        </div>
        <span id="distortionVal" style="color:#429869;">0</span>
      </div>

      <canvas id="oscilloscope" width="500" height="50"></canvas>
    </div>
  
    <div class="TECLADO">
      <!-- Teclas blancas -->
      <div class="TECLAS_BLANCAS"></div> <!-- C -->
      <div class="TECLAS_BLANCAS"></div> <!-- D -->
      <div class="TECLAS_BLANCAS"></div> <!-- E -->
      <div class="TECLAS_BLANCAS"></div> <!-- F -->
      <div class="TECLAS_BLANCAS"></div> <!-- G -->
      <div class="TECLAS_BLANCAS"></div> <!-- A -->
      <div class="TECLAS_BLANCAS"></div> <!-- B -->
      <div class="TECLAS_BLANCAS"></div> <!-- C -->
      <div class="TECLAS_BLANCAS"></div> <!-- D -->
      <div class="TECLAS_BLANCAS"></div> <!-- E -->
      <div class="TECLAS_BLANCAS"></div> <!-- F -->
      <div class="TECLAS_BLANCAS"></div> <!-- G -->
      <div class="TECLAS_BLANCAS"></div> <!-- A -->
      <div class="TECLAS_BLANCAS"></div> <!-- B -->

      <!-- Teclas negras posicionadas a mano -->
      <div class="TECLAS_NEGRAS" style="left: 45px;"></div>   <!-- C# -->
      <div class="TECLAS_NEGRAS" style="left: 107px;"></div>  <!-- D# -->
      <!-- NO hay tecla negra entre E y F -->
      <div class="TECLAS_NEGRAS" style="left: 231px;"></div>  <!-- F# -->
      <div class="TECLAS_NEGRAS" style="left: 295px;"></div>  <!-- G# -->
      <div class="TECLAS_NEGRAS" style="left: 360px;"></div>  <!-- A# -->
      <!-- NO hay tecla negra entre B y C -->
      <div class="TECLAS_NEGRAS" style="left: 485px;"></div>  <!-- C# -->
      <div class="TECLAS_NEGRAS" style="left: 550px;"></div>  <!-- D# -->
      <!-- NO E# -->
      <div class="TECLAS_NEGRAS" style="left: 675px;"></div>  <!-- F# -->
      <div class="TECLAS_NEGRAS" style="left: 740px;"></div>  <!-- G# -->
      <div class="TECLAS_NEGRAS" style="left: 800px;"></div>  <!-- A# -->
    </div>
  </div>
<script>
const ctx = new (window.AudioContext || window.webkitAudioContext)();
const analyser = ctx.createAnalyser();
analyser.fftSize = 2048;
const dataArray = new Uint8Array(analyser.fftSize);
const canvas = document.getElementById("oscilloscope");
const canvasCtx = canvas.getContext("2d");

const keys = "asdfghjklxcvbnqwertyuiop";

const keyToFreq = {
  a: 261.63, q: 277.18, s: 293.66, w: 311.13,
  d: 329.63, f: 349.23, e: 369.99, g: 392.00,
  r: 415.30, h: 440.00, t: 466.16, j: 493.88,
  k: 523.25, y: 554.37, l: 587.33, u: 622.25,
  x: 659.25, c: 698.46, i: 739.99, v: 783.99,
  o: 830.61, b: 880.00, p: 932.33, n: 987.77
};

let selectedWave = "sine";
let customBuffer = null;
let transpose = 0;
const pressedKeys = {};

// Actualizo el bot√≥n seleccionado inicialmente
document.querySelectorAll(".wave-btn").forEach(btn => {
  if (btn.dataset.wave === selectedWave) {
    btn.classList.add("selected");
  }
});

// Manejo botones de onda
document.querySelectorAll(".wave-btn").forEach(btn => {
  if (btn.id !== "customWaveBtn") {
    btn.addEventListener("click", () => {
      selectedWave = btn.dataset.wave;
      document.querySelectorAll(".wave-btn").forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");
      console.log("Onda seleccionada:", selectedWave);
    });
  }
});

// Bot√≥n custom click simple
document.getElementById("customWaveBtn").addEventListener("click", () => {
  if (customBuffer) {
    selectedWave = "custom";
    document.querySelectorAll(".wave-btn").forEach(b => b.classList.remove("selected"));
    document.getElementById("customWaveBtn").classList.add("selected");
    console.log("üéµ Onda custom seleccionada.");
  } else {
    console.log("‚ö†Ô∏è A√∫n no se carg√≥ ninguna onda personalizada.");
  }
});

// Bot√≥n custom doble clic para cargar archivo
document.getElementById("customWaveBtn").addEventListener("dblclick", () => {
  document.getElementById("customFile").click();
});

// Cargar archivo custom
document.getElementById("customFile").addEventListener("change", function () {
  const file = this.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (ev) {
      ctx.decodeAudioData(ev.target.result, buffer => {
        customBuffer = buffer;
        selectedWave = "custom";
        document.querySelectorAll(".wave-btn").forEach(b => b.classList.remove("selected"));
        document.getElementById("customWaveBtn").classList.add("selected");
        console.log("‚úî Archivo custom cargado correctamente.");
      }, err => {
        console.error("‚ùå Error al decodificar audio:", err);
      });
    };
    reader.readAsArrayBuffer(file);
  }
});

function createOsc(freqToUse) {
  let osc;
  const now = ctx.currentTime;

  if (selectedWave === "custom" && customBuffer) {
    osc = ctx.createBufferSource();
    osc.buffer = customBuffer;
    osc.playbackRate.setValueAtTime(freqToUse / 440, now);
    osc.loop = true;
  } else if (selectedWave === "white") {
    osc = ctx.createBufferSource();
    const buffer = ctx.createBuffer(1, 44100, ctx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < 44100; i++) {
      data[i] = Math.random() * 2 - 1;
    }
    osc.buffer = buffer;
    osc.loop = true;
  } else {
    osc = ctx.createOscillator();
    osc.frequency.setValueAtTime(freqToUse, now);
    osc.type = selectedWave;
  }

  return osc;
}

function playNote(key) {
  if (pressedKeys[key]) return;

  const freq = keyToFreq[key] * Math.pow(2, transpose / 12);
  const volume = parseFloat(document.getElementById("volume").value);
  const attack = getAttack();
  const decay = getDecay();
  const sustain = getSustain();
  const release = getRelease();
  const filterFreq = getFilter();
  const delayTime = getDelay();
  const distortionAmount = getDistortion();
  const harmonicsCount = parseInt(getHarmonics());
  const detuneValue = parseFloat(document.getElementById("detune").value); // ‚úÖ corregido
  const now = ctx.currentTime;

  // Ganancia principal
  const noteGain = ctx.createGain();
  noteGain.gain.setValueAtTime(0, now);

  // Filtro
  const filter = ctx.createBiquadFilter();
  filter.type = "lowpass";
  filter.frequency.setValueAtTime(filterFreq, now);

  // Delay
  const delay = ctx.createDelay();
  delay.delayTime.setValueAtTime(delayTime, now);

  // Distorsi√≥n
  const distortion = ctx.createWaveShaper();
  distortion.curve = makeDistortionCurve(distortionAmount);
  distortion.oversample = "4x";

  // Oscilador fundamental
  const fundamentalOsc = createOsc(freq);
  if ("detune" in fundamentalOsc) {
    fundamentalOsc.detune.setValueAtTime(detuneValue, now);
  }

  const fundamentalGain = ctx.createGain();
  fundamentalGain.gain.setValueAtTime(1, now);
  fundamentalOsc.connect(fundamentalGain);
  fundamentalGain.connect(filter);

  // Armonicos
  const harmonicOscs = [];
  for (let i = 2; i <= harmonicsCount + 1; i++) {
    const ho = ctx.createOscillator();
    ho.type = "sine";
    ho.frequency.setValueAtTime(freq * i, now);
    const hGain = ctx.createGain();
    hGain.gain.setValueAtTime(1 / i, now);
    ho.connect(hGain);
    hGain.connect(filter);
    harmonicOscs.push({ osc: ho, gain: hGain });
  }

  // Conexiones finales
  filter.connect(distortion);
  distortion.connect(delay);
  delay.connect(noteGain);
  noteGain.connect(analyser);
  analyser.connect(ctx.destination);

  // Envolvente ADSR
  noteGain.gain.cancelScheduledValues(now);
  noteGain.gain.setValueAtTime(0, now);
  noteGain.gain.linearRampToValueAtTime(volume, now + attack);
  noteGain.gain.linearRampToValueAtTime(volume * sustain, now + attack + decay);

  fundamentalOsc.start(now);
  harmonicOscs.forEach(h => h.osc.start(now));

  // Guardar en objeto de notas activas
  pressedKeys[key] = {
    fundamentalOsc,
    harmonicOscs,
    noteGain,
    release,
    stopTime: null
  };
}


function stopNote(key) {
  if (!pressedKeys[key]) return;
  const { fundamentalOsc, harmonicOscs, noteGain, release, stopTime } = pressedKeys[key];
  if (stopTime) return; // ya est√° parando
  const now = ctx.currentTime;
  noteGain.gain.cancelScheduledValues(now);
  noteGain.gain.setValueAtTime(noteGain.gain.value, now);
  noteGain.gain.linearRampToValueAtTime(0, now + release);
  fundamentalOsc.stop(now + release + 0.05);
  harmonicOscs.forEach(h => h.osc.stop(now + release + 0.05));
  pressedKeys[key].stopTime = now + release + 0.05;
  // Limpieza futura
  setTimeout(() => {
    delete pressedKeys[key];
  }, (release + 0.1) * 1000);
}

// Distorsi√≥n helper
function makeDistortionCurve(amount) {
  const k = typeof amount === 'number' ? amount : 0;
  const n_samples = 44100;
  const curve = new Float32Array(n_samples);
  const deg = Math.PI / 180;
  for (let i = 0; i < n_samples; i++) {
    const x = i * 2 / n_samples - 1;
    curve[i] = ((3 + k) * x * 20 * deg) / (Math.PI + k * Math.abs(x));
  }
  return curve;
}

// Lectura valores de controles - usar IDs para controlar el valor (retornar n√∫mero o default)
function getAttack() {
  const val = parseFloat(document.getElementById("attackVal").textContent);
  return isNaN(val) ? 0.05 : val;
}
function getDecay() {
  const val = parseFloat(document.getElementById("decayVal").textContent);
  return isNaN(val) ? 0.3 : val;
}
function getSustain() {
  const val = parseFloat(document.getElementById("sustainVal").textContent);
  return isNaN(val) ? 0.7 : val;
}
function getRelease() {
  const val = parseFloat(document.getElementById("releaseVal").textContent);
  return isNaN(val) ? 0.5 : val;
}
function getFilter() {
  const val = parseFloat(document.getElementById("filterVal").textContent);
  return isNaN(val) ? 5000 : val;
}
function getDelay() {
  const val = parseFloat(document.getElementById("delayVal").textContent);
  return isNaN(val) ? 0.2 : val;
}
function getDistortion() {
  const val = parseFloat(document.getElementById("distortionVal").textContent);
  return isNaN(val) ? 0 : val;
}
function getHarmonics() {
  const val = parseInt(document.getElementById("harmonicsVal").textContent);
  return isNaN(val) ? 0 : val;
}

// Eventos volumen y detune slider (actualiza texto)
const volumeSlider = document.getElementById("volume");
const volumeVal = document.getElementById("volumeVal");
volumeSlider.addEventListener("input", () => {
  volumeVal.textContent = parseFloat(volumeSlider.value).toFixed(2);
});

const detuneSlider = document.getElementById("detune");
const detuneValSpan = document.getElementById("detuneVal");
detuneSlider.addEventListener("input", () => {
  detuneValSpan.textContent = detuneSlider.value;
});

// Transpose botones
document.getElementById("transposeDown").addEventListener("click", () => {
  transpose--;
  console.log("Transpose:", transpose);
});
document.getElementById("transposeUp").addEventListener("click", () => {
  transpose++;
  console.log("Transpose:", transpose);
});

// Teclado
window.addEventListener("keydown", e => {
  if (keys.includes(e.key) && !e.repeat) {
    playNote(e.key);
  }
});

window.addEventListener("keyup", e => {
  if (keys.includes(e.key)) {
    stopNote(e.key);
  }
});

// Funci√≥n para dibujar osciloscopio
function drawOscilloscope() {
  requestAnimationFrame(drawOscilloscope);
  analyser.getByteTimeDomainData(dataArray);

  canvasCtx.fillStyle = "black";
  canvasCtx.fillRect(0, 0, canvas.width, canvas.height);

  canvasCtx.lineWidth = 2;
  canvasCtx.strokeStyle = "#0f0";

  canvasCtx.beginPath();
  const sliceWidth = canvas.width * 1.0 / analyser.fftSize;
  let x = 0;
  for(let i = 0; i < analyser.fftSize; i++) {
    const v = dataArray[i] / 128.0;
    const y = v * canvas.height / 2;
    if (i === 0) {
      canvasCtx.moveTo(x, y);
    } else {
      canvasCtx.lineTo(x, y);
    }
    x += sliceWidth;
  }
  canvasCtx.lineTo(canvas.width, canvas.height / 2);
  canvasCtx.stroke();
}
drawOscilloscope();

// Funci√≥n para crear knobs con arrastre y actualizar valores
function createKnob(knobId, valueSpanId, min = 0, max = 1, initial = 0.5, step = 0.01, scale = v => v) {
  const knob = document.getElementById(knobId);
  const marker = knob.querySelector(".knob-marker");
  const valueSpan = document.getElementById(valueSpanId);

  let dragging = false;
  let lastY;

  function updateValueFromAngle(angle) {
    // Angle en grados: entre -135 y 135
    let valueNorm = (angle + 135) / 270; // normalizado 0-1
    if (valueNorm < 0) valueNorm = 0;
    if (valueNorm > 1) valueNorm = 1;
    let val = min + valueNorm * (max - min);
    val = Math.round(val / step) * step;
    valueSpan.textContent = val.toFixed(2);
    marker.style.transform = `rotate(${angle}deg)`;
  }

  knob.addEventListener("mousedown", e => {
    dragging = true;
    lastY = e.clientY;
    e.preventDefault();
  });

  window.addEventListener("mouseup", () => {
    dragging = false;
  });

  window.addEventListener("mousemove", e => {
    if (!dragging) return;
    const deltaY = lastY - e.clientY;
    lastY = e.clientY;
    const currentAngle = parseFloat(marker.style.transform.replace(/[^-?\d\.]/g, '')) || 0;
    let newAngle = currentAngle + deltaY * 2;
    if (newAngle > 135) newAngle = 135;
    if (newAngle < -135) newAngle = -135;
    updateValueFromAngle(newAngle);
  });

  // Inicializar en valor
  const initialAngle = ( (initial - min) / (max - min) ) * 270 - 135;
  updateValueFromAngle(initialAngle);
}

// Crear knobs
createKnob("attackKnob", "attackVal", 0, 2, 0.05, 0.01);
createKnob("decayKnob", "decayVal", 0, 2, 0.3, 0.01);
createKnob("sustainKnob", "sustainVal", 0, 1, 0.7, 0.01);
createKnob("releaseKnob", "releaseVal", 0, 3, 0.5, 0.01);
createKnob("filterKnob", "filterVal", 0, 20000, 5000, 1);
createKnob("delayKnob", "delayVal", 0, 1, 0.2, 0.01);
createKnob("distortionKnob", "distortionVal", 0, 400, 0, 1);
createKnob("harmonicsKnob", "harmonicsVal", 0, 10, 0, 1);

</script>
</body>
</html>
